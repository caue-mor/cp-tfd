{% extends "base.html" %}

{% block title %}Cupido - Sua Mensagem Anonima{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="logo">ğŸ’˜</div>
        <h1>Cupido</h1>
        <p class="subtitle">{{ plan.label }}</p>
        {% if order.buyer_name %}
        <p class="greeting">Oi, {{ order.buyer_name }}!</p>
        {% endif %}
    </div>

    {% if plan.max_messages > 1 %}
    <div class="message-counter">
        <span class="counter-badge">Mensagem {{ messages_sent + 1 }} de {{ plan.max_messages }}</span>
        <span class="counter-remaining">{{ remaining }} restante{{ 's' if remaining != 1 else '' }}</span>
    </div>
    {% endif %}

    {% if plan.has_presentation %}
    {# Premium plan - image upload form #}
    <form id="premium-form" enctype="multipart/form-data">
        <div class="form-group">
            <label for="recipient_phone">Telefone do destinatario</label>
            <input type="tel" id="recipient_phone" name="recipient_phone"
                   placeholder="(11) 99999-9999" required
                   {% if order.recipient_phone %}value="{{ order.recipient_phone }}" readonly{% endif %}>
        </div>

        <div class="form-group">
            <label for="title">Titulo da apresentacao</label>
            <input type="text" id="title" name="title"
                   value="Uma historia para voce" maxlength="100">
        </div>

        <div class="form-group">
            <label for="sender_nickname">De quem? (anonimo)</label>
            <input type="text" id="sender_nickname" name="sender_nickname"
                   value="Alguem especial" maxlength="50">
        </div>

        {% if plan.has_audio and plan.audio_char_limit > 0 %}
        <div class="form-group">
            <label for="premium_audio_text">ğŸ”Š Texto para audio do Stitch</label>
            <p class="hint">Escreva o que o Stitch vai falar em audio junto com a apresentacao</p>
            <textarea id="premium_audio_text" name="audio_text" rows="3"
                      placeholder="Ex: Oi, eu sou o Stitch e alguem preparou algo muito especial pra voce..."
                      maxlength="{{ plan.audio_char_limit }}"></textarea>
            <span class="char-count">
                <span id="premium-audio-char-count">0</span>/{{ plan.audio_char_limit }} caracteres
                (~20s de audio)
            </span>
        </div>
        {% endif %}

        <div class="form-group">
            <label>Fotos (arraste ou clique)</label>
            <div id="drop-zone" class="drop-zone">
                <p>ğŸ“¸ Arraste suas fotos aqui ou clique para selecionar</p>
                <input type="file" id="file-input" name="files" multiple accept="image/*" hidden>
            </div>
            <div id="preview-container" class="preview-container"></div>
        </div>

        <button type="submit" class="btn btn-primary" id="submit-btn">
            ğŸ’˜ Enviar Apresentacao
        </button>
    </form>
    {% else %}
    {# Standard plans - text form (1 message at a time) #}
    <form id="message-form">
        <div class="form-group">
            <label for="recipient_phone">Telefone do destinatario</label>
            <input type="tel" id="recipient_phone" name="recipient_phone"
                   placeholder="(11) 99999-9999" required>
        </div>

        <div class="form-group">
            <label for="message">Sua mensagem anonima</label>
            <textarea id="message" name="message" rows="4"
                      placeholder="Escreva aqui a mensagem que o Cupido vai entregar..."
                      required maxlength="1000"></textarea>
            <span class="char-count"><span id="char-count">0</span>/1000</span>
        </div>

        {% if plan.has_audio and plan.audio_char_limit > 0 %}
        <div class="form-group">
            <label for="audio_text">ğŸ”Š Texto para audio do Stitch</label>
            <p class="hint">Escreva o que o Stitch vai falar em audio (separado da mensagem escrita)</p>
            <textarea id="audio_text" name="audio_text" rows="3"
                      placeholder="Ex: Oi, eu sou o Stitch e alguem te ama muito..."
                      maxlength="{{ plan.audio_char_limit }}"></textarea>
            <span class="char-count">
                <span id="audio-char-count">0</span>/{{ plan.audio_char_limit }} caracteres
                (~{{ '20' if plan.audio_char_limit == 300 else '10' }}s de audio)
            </span>
        </div>
        {% endif %}

        <div class="form-group">
            <label for="sender_nickname">De quem? (anonimo)</label>
            <input type="text" id="sender_nickname" name="sender_nickname"
                   value="Alguem especial" maxlength="50">
        </div>

        <div class="schedule-section">
            <label class="checkbox-label">
                <input type="checkbox" id="schedule-toggle">
                â° Agendar envio surpresa
            </label>
            <div id="schedule-picker" style="display:none">
                <p class="hint">Escolha quando a mensagem sera entregue:</p>
                <input type="datetime-local" id="scheduled_at" name="scheduled_at">
            </div>
        </div>

        <button type="submit" class="btn btn-primary" id="submit-btn">
            ğŸ’˜ Enviar Mensagem
        </button>
    </form>
    {% endif %}
</div>

<input type="hidden" id="form-token" value="{{ token }}">
<input type="hidden" id="max-messages" value="{{ plan.max_messages }}">
<input type="hidden" id="messages-sent" value="{{ messages_sent }}">
<input type="hidden" id="remaining" value="{{ remaining }}">
<input type="hidden" id="has-audio" value="{{ 'true' if plan.has_audio and plan.audio_char_limit > 0 else 'false' }}">
<input type="hidden" id="audio-char-limit" value="{{ plan.audio_char_limit }}">
<input type="hidden" id="is-premium" value="{{ 'true' if plan.has_presentation else 'false' }}">
{% endblock %}

{% block scripts %}
<script src="/static/js/form.js"></script>
{% if plan.has_presentation %}
<script src="/static/js/premium-upload.js"></script>
{% endif %}
{% endblock %}
